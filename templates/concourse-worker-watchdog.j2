#!/bin/bash

watchdog() {
    #WORKER_PID=$1

    # Grace periode just to be sure Concourse have enough time during the
    # First startup
    sleep 120

    RETRY=3
    while(true); do
        FAIL=0

        curl --silent 127.0.0.1:8888 || FAIL=1

        #if [[ $FAIL -eq 0 ]]; then
        if [[ $FAIL -eq 1 ]]; then
            if [[ $RETRY -ne 0 ]]; then
              echo "retry $RETRY"
              ((RETRY=RETRY-1))
            else

              LOCK_RETRY=3
              while [[ $LOCK_RETRY -gt 0 ]]; do
                  fuser /tmp/concourse-retire-worker.lock >/dev/null 2>&1
                  free_retire_lock=$?

                  if [[ $free_retire_lock -eq 1 ]]; then
                      echo "restart worker"
                      /bin/systemctl restart concourse-worker
                      break
                  else
                      echo "worker is already being retired $LOCK_RETRY left"
                      ((LOCK_RETRY=LOCK_RETRY-1))
                      sleep 15
                  fi
              done

              if [[ $LOCK_RETRY -eq 0 ]]; then
                  echo "lock still held after retries â€” forcing restart"
                  /bin/systemctl restart concourse-worker
              fi
              RETRY=3
            fi
        else
            echo "concourse-worker healthcheck ok"
            #sleep 1
            RETRY=3
        fi
        sleep 15
    done
}

watchdog
